---
import GalleryInfo from './GalleryInfo.astro';
import Layout from './Layout.astro';
import {
  getAllWinnersByContestAndCategory,
  getCategoryNamesByIds,
  getContestTitleByContestId,
} from './queries.js';
import RunnerUpImages from './RunnerUpImages.astro';
import TopWinnerImage from './TopWinnerImage.astro';

type Props = {
  contestId: string;
  categoryId: string;
};

const { contestId, categoryId }: Props = Astro.props;

if (!Astro.locals.runtime.env.DB) {
  throw new Error('DB is not available');
}

const contestTitle = await getContestTitleByContestId(
  Astro.locals.runtime.env.DB,
  contestId
);

// Fetch results for specific contest and category
const contestResults = await getAllWinnersByContestAndCategory(
  Astro.locals.runtime.env.DB,
  contestId,
  categoryId
);

// Sort results in proper contest order: first, second, third, runner-up
const sortedResults = contestResults.sort((a, b) => {
  const order = { first: 1, second: 2, third: 3, 'runner-up': 4 };
  return (
    order[a.result as keyof typeof order] -
    order[b.result as keyof typeof order]
  );
});

// Get category names
const categoryIds = [...new Set(sortedResults.map(w => w.categoryId))];
const categoryMap = await getCategoryNamesByIds(
  Astro.locals.runtime.env.DB,
  categoryIds
);

// Judges are now handled by the Jury component

// Process images - using direct R2 URLs for now
const processedImages = sortedResults.map(result => {
  const categoryName = categoryMap.get(result.categoryId) || result.categoryId;

  // Use our public images API route with optimization for web delivery
  const imageUrl = `/api/publicImages/${result.r2Key}`;

  return {
    ...result,
    imageUrl,
    categoryName,
    author:
      result.firstName && result.lastName
        ? `${result.firstName} ${result.lastName}`
        : 'Anonymous',
  };
});

const firstPlace = processedImages?.[0];
const secondPlace = processedImages?.[1];
const thirdPlace = processedImages?.[2];
const runnerUps = processedImages?.slice(3) || [];
---

<Layout>
  <GalleryInfo
    contestTitle={contestTitle}
    contestId={contestId}
    activeCategoryId={categoryId}
  />

  <!-- Winners Section -->
  <div class="mt-24 space-y-16">
    <!-- First Place -->
    {
      firstPlace && (
        <div class="space-y-8">
          <TopWinnerImage
            result="First Place"
            imageUrl={firstPlace.imageUrl}
            title={firstPlace.title}
            author={firstPlace.author}
          />
        </div>
      )
    }

    <!-- Second Place -->
    {
      secondPlace && (
        <div class="space-y-8">
          <TopWinnerImage
            result="Second Place"
            imageUrl={secondPlace.imageUrl}
            title={secondPlace.title}
            author={secondPlace.author}
          />
        </div>
      )
    }

    <!-- Third Place -->
    {
      thirdPlace && (
        <div class="space-y-8">
          <TopWinnerImage
            result="Third Place"
            imageUrl={thirdPlace.imageUrl}
            title={thirdPlace.title}
            author={thirdPlace.author}
          />
        </div>
      )
    }

    <!-- Runner Ups -->
    <RunnerUpImages runnerUps={runnerUps} />
  </div>
</Layout>
