---
import GalleryInfo from './GalleryInfo.astro';
import {
  getCategoryNamesByIds,
  getContestTitleByContestId,
  getFirstPlaceWinnersByContestId,
} from './queries.js';
import TopWinnerImage from './TopWinnerImage.astro';

type Props = {
  contestId: string;
};

const { contestId } = Astro.props;

if (!Astro.locals.runtime.env.DB) {
  throw new Error('DB is not available');
}

// Fetch only first place winners for the specified contest across all categories
const firstPlaceWinners = await getFirstPlaceWinnersByContestId(
  Astro.locals.runtime.env.DB,
  contestId
);

const contestTitleFormatted = await getContestTitleByContestId(
  Astro.locals.runtime.env.DB,
  contestId
);

// Get category names
const categoryIds = [...new Set(firstPlaceWinners.map(w => w.categoryId))];
const categoryMap = await getCategoryNamesByIds(
  Astro.locals.runtime.env.DB,
  categoryIds
);

// Judges are now handled by the Jury component

// Process images - using direct R2 URLs for now
const processedImages = firstPlaceWinners.map(result => {
  const categoryName = categoryMap.get(result.categoryId) || result.categoryId;

  // Use our public images API route with optimization for web delivery
  const imageUrl = `/api/publicImages/${result.r2Key}`;

  return {
    ...result,
    imageUrl,
    categoryName,
    author:
      result.firstName && result.lastName
        ? `${result.firstName} ${result.lastName}`
        : 'Anonymous',
  };
});
---

<GalleryInfo contestTitle={contestTitleFormatted} contestId={contestId} />

<div class="mt-24 space-y-16">
  {
    processedImages.length > 0 ? (
      processedImages.map(winner => (
        <div class="space-y-4">
          <TopWinnerImage
            result={`${winner.categoryName} Winner`}
            imageUrl={winner.imageUrl}
            title={winner.title}
            author={winner.author}
          />
        </div>
      ))
    ) : (
      <div class="text-center py-16">
        <h3 class="text-2xl font-light text-gray-400">
          No winners found for {contestTitleFormatted}
        </h3>
        <p class="text-gray-500 mt-4">
          This contest may not have any submissions or results yet.
        </p>
      </div>
    )
  }
</div>
